!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var r;"undefined"!=typeof window?r=window:"undefined"!=typeof global?r=global:"undefined"!=typeof self&&(r=self),r.pJS=e()}}(function(){return function e(r,t,n){function o(i,s){if(!t[i]){if(!r[i]){var u="function"==typeof require&&require;if(!s&&u)return u(i,!0);if(a)return a(i,!0);var c=new Error("Cannot find module '"+i+"'");throw c.code="MODULE_NOT_FOUND",c}var p=t[i]={exports:{}};r[i][0].call(p.exports,function(e){var t=r[i][1][e];return o(t?t:e)},p,p.exports,e,r,t,n)}return t[i].exports}for(var a="function"==typeof require&&require,i=0;i<n.length;i++)o(n[i]);return o}({1:[function(e,r){var t=arguments[3],n=arguments[4],o=arguments[5],a=JSON.stringify;r.exports=function(e){for(var r,i=Object.keys(o),s=0,u=i.length;u>s;s++){var c=i[s];if(o[c].exports===e){r=c;break}}if(!r){r=Math.floor(Math.pow(16,8)*Math.random()).toString(16);for(var p={},s=0,u=i.length;u>s;s++){var c=i[s];p[c]=c}n[r]=[Function(["require","module","exports"],"("+e+")(self)"),p]}var f=Math.floor(Math.pow(16,8)*Math.random()).toString(16),d={};d[r]=r,n[f]=[Function(["require"],"require("+a(r)+")(self)"),d];var l="("+t+")({"+Object.keys(n).map(function(e){return a(e)+":["+n[e][0]+","+a(n[e][1])+"]"}).join(",")+"},{},["+a(f)+"])",h=window.URL||window.webkitURL||window.mozURL||window.msURL;return new Worker(h.createObjectURL(new Blob([l],{type:"text/javascript"})))}},{}],2:[function(e,r){function t(){for(var e={},r=0;r<arguments.length;r++){var t=arguments[r];for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}return e}r.exports=t},{}],3:[function(e,r){function t(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}return e}r.exports=t},{}],4:[function(e,r){function t(e,r){e.__verifyPreviousOperation();var t=e.depth+1,n=p.extendChainContext(t,r.localContext,e.chainContext),o=s(r.operation,r.f,r.seed,r.identity,r.identityReducer),a={source:e.source,parts:e.parts,operation:o,globalContext:e.globalContext,chainContext:n,previousOperations:e.operations,depth:t};return new l(a)}var n=e("./job_packager"),o=e("./workers"),a=e("./typed_array_merger"),i=e("./operation_names"),s=e("./operation_packager"),u=e("./errors"),c=e("./utils"),p=e("./chain_context"),f=e("xtend/immutable"),d={map:function(e,r,t,n){t?t(null,r):n(r)},filter:function(e,r,t,n){t?t(null,r):n(r)},reduce:function(e,r,t,n){for(var o=f(e.globalContext,e.__localContext()),a=e.operation,i=a.identityCode,s=a.seed,u=0,c=r.length;c>u;u++)s=i(s,r[u],o);t?t(null,s):n(s)}},l=function(e){this.packager=new n(e.parts,e.source),this.source=e.source,this.parts=e.parts,this.operation=e.operation,this.globalContext=e.globalContext,this.chainContext=e.chainContext;var r=e.previousOperations||[];r.push(e.operation),this.operations=r,this.depth=e.depth||0};l.prototype.__localContext=function(){return p.contextFromChainContext(this.depth,this.chainContext)},l.prototype.map=function(e,r){return t(this,{localContext:r,f:e,operation:i.MAP})},l.prototype.filter=function(e,r){return t(this,{localContext:r,f:e,operation:i.FILTER})},l.prototype.reduce=function(e,r,n,o,a){return c.isFunction(n)||(a=o,o=n,n=e),t(this,{localContext:a,f:e,seed:r,identity:o,identityReducer:n,operation:i.REDUCE})},l.prototype.seq=function(e){var r=this;return new Promise(function(t,n){var i=r.packager.generatePackages(r.operations,r.chainContext);o.sendPacks(i,function(o,s){if(o)return e?e(o):n(o),void 0;var u=s.map(function(e){var r=i[0].elementsType.replace("Shared",""),t=e.start,n=e.newEnd,o=c.createTypedArray(r,e.value);return o.subarray(t,n)}),p=a(u);return d[r.operation.name](r,p,e,t)})})},l.prototype.__verifyPreviousOperation=function(){if("reduce"===this.operation.name)throw new u.InvalidOperationError(u.messages.INVALID_CHAINING_OPERATION)},r.exports=l},{"./chain_context":5,"./errors":8,"./job_packager":10,"./operation_names":11,"./operation_packager":12,"./typed_array_merger":14,"./utils":16,"./workers":19,"xtend/immutable":2}],5:[function(e,r){var t=e("./context"),n=e("xtend"),o=r.exports={};o.serializeChainContext=function(e){return JSON.stringify(e)},o.deserializeChainContext=function(e){return JSON.parse(e)},o.extendChainContext=function(e,r,o){if(!r&&!o)return void 0;if(!r)return n(o,void 0);var a={};return a[e]=t.serializeFunctions(r),o?n(o,a):a},o.contextFromChainContext=function(e,r){return r&&r[e]?t.deserializeFunctions(r[e]):void 0}},{"./context":6,xtend:2}],6:[function(e,r){function t(e){var r=o.parseFunction(e);return{__isFunction:!0,args:r.args,code:r.body}}function n(e){return o.createFunction(e.args,e.code)}var o=e("./utils"),a={};r.exports=a,a.deserializeFunctions=function(e){return Object.keys(e).reduce(function(r,t){var i=e[t];return o.isObject(i)&&(i.__isFunction?r[t]=n(i):a.deserializeFunctions(i)),r},e)},a.serializeFunctions=function(e){var r;return e&&(r=Object.keys(e).reduce(function(r,n){var i=e[n];return r[n]=o.isFunction(i)?t(i):o.isObject(i)?a.serializeFunctions(i):i,r},{})),r}},{"./utils":16}],7:[function(e,r){var t=e("./errors"),n=e("./context"),o=r.exports=function(e){if(!e)throw new t.InvalidArgumentsError(t.messages.INVALID_PARTS);this.parts=e};o.prototype.generatePackages=function(e){if(!e)throw new t.InvalidArgumentsError(t.messages.INVALID_CONTEXT);for(var r=new Array(this.parts),o=0;o<this.parts;o++)r[o]={index:o,contextUpdate:JSON.stringify(n.serializeFunctions(e))};return r}},{"./context":6,"./errors":8}],8:[function(e,r){var t=r.exports={},n=function(e){this.name="InvalidOperationError",this.message=e||"Invalid Operation"};n.prototype=new Error,n.prototype.constructor=n,t.InvalidOperationError=n;var o=function(e){this.name="InvalidArgumentsError",this.message=e||"Invalid Arguments"};o.prototype=new Error,o.prototype.constructor=o,t.InvalidArgumentsError=o;var a=function(e){this.name="WorkerError",this.message=e||"An unknown error ocurred in the worker"};a.prototype=new Error,a.prototype.constructor=a,t.WorkerError=a,t.messages={CONSECUTIVE_INITS:"You should not recall init if the library is already initialized.",TERMINATE_WITHOUT_INIT:"You should not terminate pjs if it was not initialized before.",PARTITIONER_ARGUMENT_IS_NOT_TYPED_ARRAY:"Expected TypedArray argument.",ZERO_ARRAYS_TO_MERGE:"Zero arrays to merge. Provide at least one.",INVALID_PARTS:"Invalid number of parts.",INVALID_CONTEXT:"Invalid context.",PART_ALREADY_COLLECTED:"Tried to collect part {0} more than once",MISSING_CODE_OR_PATH:'Missing "code" or "functionPath" argument to package.',INVALID_IDENTITY_CODE:"Invalid identity code argument to package.",INVALID_ELEMENTS:"Invalid number of elements to package.",INVALID_PACKAGE_INDEX:"Package index should be not negative and less than {0}.",INVALID_TYPED_ARRAY:"Invalid argument. It should be of TypedArray.",INVALID_OPERATION:"Invalid pjs operation. Possible values are 'filter', 'map' or 'reduce'.",INVALID_OPERATIONS:"Invalid operation chain sent to JobPackager. Either undefined or empty.",MISSING_SEED:"Missing Seed argument for reduce operation packaging.",MISSING_IDENTITY:"Missing Identity argument for reduce operation packaging.",INVALID_CHAINING_OPERATION:"Can not perform more chaining after reduce operation."}},{}],9:[function(e,r){function t(e){if(!u.isTypedArray(e))throw new s.InvalidArgumentsError(s.messages.INVALID_TYPED_ARRAY);return new p(e,c.length,h)}function n(e){if(l)throw new s.InvalidOperationError(s.messages.CONSECUTIVE_INITS);e=e||{};var r=navigator.hardwareConcurrency||e.maxWorkers||1,t=e.maxWorkers||r,n=Math.min(t,r);c.init(n);var o={get workers(){return c.length}};u.getter(i,"config",o),u.getter(i,"contextUpdatePackager",new f(c.length)),l=!0}function o(e,r){var t=this;return new Promise(function(n,o){var a=t.contextUpdatePackager.generatePackages(e);c.sendPacks(a,function(t){return t?(r?r(t):o(t),void 0):(d(h,e),r?r():n(),void 0)})})}function a(){if(!l)throw new s.InvalidOperationError(s.messages.TERMINATE_WITHOUT_INIT);c.terminate(),h={},delete i.config,delete i.contextUpdatePackager,l=!1}var i,s=e("./errors"),u=e("./utils"),c=e("./workers"),p=e("./wrapped_typed_array"),f=e("./context_update_packager"),d=e("xtend/mutable"),l=!1,h={};i=r.exports=t,i.init=n,i.terminate=a,i.updateContext=o},{"./context_update_packager":7,"./errors":8,"./utils":16,"./workers":19,"./wrapped_typed_array":20,"xtend/mutable":3}],10:[function(e,r){var t=e("./errors"),n=e("./utils"),o=e("./typed_array_partitioner"),a=e("./chain_context"),i=e("./operation_names");i=Object.keys(i).map(function(e){return i[e]});var s=r.exports=function(e,r){if(!e)throw new t.InvalidArgumentsError(t.messages.INVALID_PARTS);if(!r)throw new t.InvalidArgumentsError(t.messages.INVALID_ELEMENTS);this.parts=e,this.elements=r};s.prototype.generatePackages=function(e,r){if(!e||!e.length)throw new t.InvalidArgumentsError(t.messages.INVALID_OPERATIONS);var s=e.map(function(e){if(!e.code&&!e.functionPath)throw new t.InvalidArgumentsError(t.messages.MISSING_CODE_OR_PATH);if(!e.name||-1===i.indexOf(e.name))throw new t.InvalidArgumentsError(t.messages.INVALID_OPERATION);if(!e.functionPath){var r=n.parseFunction(e.code.toString());return{identity:e.identity,args:r.args,code:r.body,name:e.name}}return{identity:e.identity,name:e.name,functionPath:e.functionPath}}),u=n.getTypedArrayType(this.elements),c=new o(this.parts),p=c.partition(this.elements),f=n.isSharedArray(this.elements),d=a.serializeChainContext(r);return p.map(function(e,r){var t,n,o;return f?(t=e.sharedArray.buffer,n=e.from,o=e.to):(t=e.buffer,n=0,o=e.length),{index:r,start:n,end:o,buffer:t,operations:s,elementsType:u,ctx:d}})}},{"./chain_context":5,"./errors":8,"./operation_names":11,"./typed_array_partitioner":15,"./utils":16}],11:[function(e,r){r.exports={MAP:"map",FILTER:"filter",REDUCE:"reduce"}},{}],12:[function(e,r){var t=e("./errors"),n=e("./utils"),o=e("./operation_names");o=Object.keys(o).map(function(e){return o[e]}),r.exports=function(e,r,a,i,s){if(!e||-1===o.indexOf(e))throw new t.InvalidArgumentsError(t.messages.INVALID_OPERATION);if(!r)throw new t.InvalidArgumentsError(t.messages.INVALID_CODE);if("reduce"===e&&"undefined"==typeof s)throw new t.InvalidArgumentsError(t.messages.INVALID_IDENTITY_CODE);if("reduce"===e&&"undefined"==typeof a)throw new t.InvalidArgumentsError(t.messages.MISSING_SEED);if("reduce"===e&&"undefined"==typeof i)throw new t.InvalidArgumentsError(t.messages.MISSING_IDENTITY);var u={name:e,seed:a,identity:i,identityCode:s},c=n.isFunction(r)?"code":"functionPath";return u[c]=r,u}},{"./errors":8,"./operation_names":11,"./utils":16}],13:[function(e,r){var t=e("./errors.js"),n=e("./utils.js"),o=r.exports=function(e,r){if(!e)throw new t.InvalidArgumentsError(t.messages.INVALID_PARTS);if(!r)throw new t.InvalidArgumentsError(t.messages.MISSING_CALLBACK);this.cb=r,this.parts=e,this.collected=new Array(e),this.completed=0,this.error=null};o.prototype.onError=function(e){this.error||(this.error=new t.WorkerError(e)),this.updateCompleted()},o.prototype.onPart=function(e){if(this.error)return this.updateCompleted();if(this.collected[e.index])throw new t.InvalidArgumentsError(n.format(t.messages.PART_ALREADY_COLLECTED,e.index));this.collected[e.index]={value:e.value,start:e.start,newEnd:e.newEnd},this.updateCompleted()},o.prototype.updateCompleted=function(){return++this.completed===this.parts?this.error?this.cb(this.error):this.cb(null,this.collected):void 0}},{"./errors.js":8,"./utils.js":16}],14:[function(e,r){var t=e("./errors.js");r.exports=function(e){if(!e.length)throw new t.InvalidArgumentsError(t.messages.ZERO_ARRAYS_TO_MERGE);var r=e[0];if(1===e.length)return r;for(var n=e.reduce(function(e,r){return e+r.length},0),o=new r.constructor(n),a=0,i=0;i<e.length;i++){var s=e[i];o.set(s,a),a+=s.length}return o}},{"./errors.js":8}],15:[function(e,r){var t=e("./utils.js"),n=e("./errors.js"),o=function(e,r,t){var n=e.subarray(r,t);return new e.constructor(n)},a=r.exports=function(e){if(!e)throw new n.InvalidArgumentsError(n.messages.INVALID_PARTS);this.parts=e};a.prototype.constructor=a,a.prototype.partition=function(e){return this.__validateTypedArray(e),this.__doPartition(e,this)},a.prototype.__validateTypedArray=function(e){if(!t.isTypedArray(e)){var r=t.format("Invalid type {0}. {1}",e,n.messages.PARTITIONER_ARGUMENT_IS_NOT_TYPED_ARRAY);throw new n.InvalidArgumentsError(r)}},a.prototype.__doPartition=function(e){var r,n=this.parts,a=e.length,i=0|Math.floor(a/n),s=0,u=0,c=t.isSharedArray(e),p=new Array(n);if(c){var f=new SharedUint32Array(e.length);f.set(e),r=new SharedUint32Array(f.buffer)}for(var d=0;n>d;d++)n-1===d?u=a:u+=i,p[d]=c?{from:s,to:u,sharedArray:r}:o(e,s,u),s+=i;return p}},{"./errors.js":8,"./utils.js":16}],16:[function(e,r){function t(e,r){var t=new Array(e);return t.push(r),Function.prototype.constructor.apply(null,t)}var n=r.exports={},o=/^function[^(]*\(([^)]*)\)[^{]*\{([\s\S]*)\}$/;n.parseFunction=function(e){var r=e.toString(),t=r.match(o),n=t[1].split(",").map(function(e){return e.trim()}),a=t[2];return{args:n,body:a}},n.isObject=function(e){return"object"==typeof e&&!Array.isArray(e)},n.isFunction=function(e){return!!(e&&e.constructor&&e.call&&e.apply)},n.createTypedArray=function(e,r){switch(e){case"SharedUint32Array":return new SharedUint32Array(r);case"Uint8Array":return new Uint8Array(r);case"Uint8ClampedArray":return new Uint8ClampedArray(r);case"Uint16Array":return new Uint16Array(r);case"Uint32Array":return new Uint32Array(r);case"Int8Array":return new Int8Array(r);case"Int16Array":return new Int16Array(r);case"Int32Array":return new Int32Array(r);case"Float32Array":return new Float32Array(r);case"Float64Array":return new Float64Array(r)}},n.getter=function(e,r,t){Object.defineProperty(e,r,{enumerable:!0,configurable:!0,get:function(){return t}})},n.isTypedArray=function(e){if(!e)return!1;var r=n.getTypedArrayType(e);switch(r){case"SharedUint32Array":case"Uint8Array":case"Int8Array":case"Uint8ClampedArray":case"Uint16Array":case"Int16Array":case"Uint32Array":case"Int32Array":case"Float32Array":case"Float64Array":return!0;default:return!1}},n.isSharedArray=function(e){return e?"SharedUint32Array"===n.getTypedArrayType(e):!1},n.getTypedArrayConstructorType=function(e){var r=e.toString();return r.substring("function ".length,r.length-"() { [native code] }".length)},n.getTypedArrayType=function(e){var r=e.toString();return r.substring("[object ".length,r.length-1)},n.format=function(e){for(var r=Array.prototype.slice.call(arguments,1),t=e,n=0;n<r.length;n++)t=t.replace("{"+n+"}",r[n]);return t},n.createFunction=function(e,r){switch(e.length){case 0:return new Function(r);case 1:return new Function(e[0],r);case 2:return new Function(e[0],e[1],r);case 3:return new Function(e[0],e[1],e[2],r);case 4:return new Function(e[0],e[1],e[2],e[3],r);default:return t(e,r)}};var a=function(e,r,t,o){var i=e[r[t]];return r.length-1===t?i:(n.isObject(i)||o(),a(i,r,++t))};n.getNested=function(e,r){var t=r.split(".");return a(e,t,0,function(){throw new Error(n.format("Cannot get nested path {0} from context",r))})}},{}],17:[function(e,r){var t=e("./worker_core");r.exports=function(e){e.addEventListener("message",function(r){var n=t(r);e.postMessage(n.message,n.transferables)})}},{"./worker_core":18}],18:[function(e,r){function t(){return"function"==typeof Map?function(){return new Map}:function(){return Object.create(null)}}function n(e){if(e.functionPath)return i.getNested(d,e.functionPath);var r=e.args,t=e.code,n=r.join(",")+t,o=f[n];return o||(o=i.createFunction(r,t),f[n]=o),o}function o(e,r){var t;if(r){r=c.deserializeChainContext(r),t={};for(var n=0;e>=n;n++)r[n]&&(t[n]=u.deserializeFunctions(r[n]))}return t}var a=e("xtend/mutable"),i=e("./utils"),s=e("xtend/immutable"),u=e("./context"),c=e("./chain_context"),p=t(),f=p(),d={},l={map:function(e,r,t,n,o){for(var a=r;t>a;a+=1)e[a]=n(e[a],o);return t},filter:function(e,r,t,n,o){for(var a=r,i=r;t>a;a+=1){var s=e[a];n(s,o)&&(e[i++]=s)}return i},reduce:function(e,r,t,n,o,a){for(var i=r,s=a;t>i;i+=1){var u=e[i];s=n(s,u,o)}return e[0]=s,1}};r.exports=function(e){var r=e.data;if(r.contextUpdate){var t=u.deserializeFunctions(JSON.parse(r.contextUpdate));return a(d,t),{message:{index:r.index}}}for(var c=r.operations,p=c.length,f=o(p,r.ctx),h=i.createTypedArray(r.elementsType.replace("Shared",""),r.buffer),g=r.start,y=r.end,m=0;p>m;m+=1){var v,A=c[m],I=A.identity,_=n(A);v=f?s(d,f[m]):d,y=l[A.name](h,g,y,_,v,I)}return{message:{index:r.index,value:h.buffer,start:g,newEnd:y},transferables:[h.buffer]}}},{"./chain_context":5,"./context":6,"./utils":16,"xtend/immutable":2,"xtend/mutable":3}],19:[function(e,r){var t=e("./result_collector"),n=e("webworkify"),o=[];Object.defineProperty(r.exports,"length",{get:function(){return o.length}}),r.exports.init=function(r){for(;r--;){var t=n(e("./worker.js"));o.push(t)}},r.exports.terminate=function(){o.forEach(function(e){e.terminate()}),o=[]},r.exports.sendPacks=function(e,r){var n=new t(o.length,r);e.forEach(function(e,r){var t=function(e){return e.target.removeEventListener("error",a),e.target.removeEventListener("message",t),n.onPart(e.data)},a=function(e){return e.preventDefault(),e.target.removeEventListener("error",a),e.target.removeEventListener("message",t),n.onError(e.message)};o[r].addEventListener("error",a),o[r].addEventListener("message",t),e.buffer?o[r].postMessage(e,[e.buffer]):o[r].postMessage(e)})}},{"./result_collector":13,"./worker.js":17,webworkify:1}],20:[function(e,r){var t=e("./operation_names"),n=e("./chain"),o=e("./operation_packager"),a=e("./chain_context"),i=e("./utils"),s=function(e,r,t){this.source=e,this.parts=r,this.globalContext=t};s.prototype.map=function(e,r){return this.__operation(t.MAP,e,r)},s.prototype.filter=function(e,r){return this.__operation(t.FILTER,e,r)},s.prototype.reduce=function(e,r,n,o,a){return i.isFunction(n)||(a=o,o=n,n=e),this.__operation(t.REDUCE,e,a,r,o,n)},s.prototype.__operation=function(e,r,t,i,s,u){var c=o(e,r,i,s,u),p=a.extendChainContext(0,t),f={source:this.source,parts:this.parts,operation:c,globalContext:this.globalContext,chainContext:p};return new n(f)},r.exports=s},{"./chain":4,"./chain_context":5,"./operation_names":11,"./operation_packager":12,"./utils":16}]},{},[9])(9)});